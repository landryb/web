#!/usr/bin/env php
<?php
require_once 'libraries';

define('INSTALLATION_PATH', PATCH_PATH . DS . 'Installation' . DS);
define('API_PATH', ROOT_PATH . 'api' . DS);
define('API_SYSPATH', ROOT_PATH . 'vendor' . DS . 'libertempo' . DS . 'api' . DS);

function createDatabase(\includes\SQL $db, string $name) : bool
{
    $req = 'CREATE DATABASE `' . $name . '`';
    $db->query($req);

    return 0 < $db->affected_rows;
}

/**
 * Définit un nom pour l'instance. Doit coller à ce que le vhost a déclaré.
 */
function nameInstance(\includes\SQL $db, string $name) : bool
{
    if (!filter_var($name, FILTER_VALIDATE_URL)) {
        return false;
    }

    $req = 'UPDATE `conges_config` SET conf_valeur = "' . $db->quote($name) . '"
    WHERE conf_nom = "URL_ACCUEIL_CONGES" LIMIT 1';
    $db->query($req);

    return true;
}

/**
 * Définit les données de configuration pour l'API
 *
 * @param array $data Données de configuration
 */
function setDataConfigurationApi(array $dbConfiguration, array $ldapConfiguration) : bool
{
    $data = [
        'db' => [
            'serveur' => $dbConfiguration['serveur'],
            'base' => $dbConfiguration['base'],
            'utilisateur' => $dbConfiguration['utilisateur'],
            'mot_de_passe' => $dbConfiguration['mot_de_passe'],
        ],
        'ldap' => [
            'serveur' => $ldapConfiguration['serveur'],
            'protocol' => $ldapConfiguration['protocol'],
            'up_serveur' => $ldapConfiguration['up_serveur'],
            'base' => $ldapConfiguration['base'],
            'utilisateur' => $ldapConfiguration['utilisateur'],
            'mot_de_passe' => $ldapConfiguration['mot_de_passe'],
            'domaine' => $ldapConfiguration['domaine'],
            'prenom' => $ldapConfiguration['prenom'],
            'nom' => $ldapConfiguration['nom'],
            'mail' => $ldapConfiguration['mail'],
            'login' => $ldapConfiguration['login'],
            'nom_affiche' => $ldapConfiguration['nom_affiche'],
            'filtre' => $ldapConfiguration['filtre'],
            'filtre_recherche' => $ldapConfiguration['filtre_recherche'],
        ],
    ];

    return file_put_contents(API_SYSPATH . 'configuration.json', json_encode($data));
}

/**
 * Execute le fichier de patch d'installation et retourne sa version
 */
function executePatch() : string
{
    $currentPatch = "0.0";
    foreach (glob(INSTALLATION_PATH . '/*.sql') as $filename) {
        $currentPatch = basename($filename, '.sql');
        // il n'est sensé n'y en avoir qu'un
        execute_sql_file($filename);
        break;
    }

    return $currentPatch;
}

display('Installation…');

// Quelques vérifications de base…
$instanceName = $argv[1] ?? null;
display('Contrôles généraux…');
if (null == $instanceName) {
    displayError("Nom d'instance vide");
}
if (\includes\SQL::existsDatabase($mysql_database)) {
    displayError('Application déjà installée');
}

display('Création base de données…');
if (!createDatabase(\includes\SQL::singletonWithoutDb(), $mysql_database)) {
    displayFail();
}

display('Création tables…');
$db = \includes\SQL::singleton();
list($major, $minor, $patch) = explode('.', executePatch());
$versionMaj = implode('.', [$major, $minor, $patch]);

display('Inscription de la dernière version…');
if(!setLastMaj($db, $versionMaj)) {
    displayFail();
}

display('Nommage de l\'instance…');
if (!nameInstance($db, $instanceName)) {
    displayFail();
}

display('Configuration de l\'API');
$dbConfiguration = [
    'serveur' => $mysql_serveur,
    'base' => $mysql_database,
    'utilisateur' => $mysql_user,
    'mot_de_passe' => $mysql_pass,
];
$ldapConfiguration = [
    'serveur' => $config_ldap_server ?? '',
    'protocol' => $config_ldap_protocol_version ?? '',
    'up_serveur' => $config_ldap_bupsvr ?? '',
    'base' => $config_basedn ?? '',
    'utilisateur' => $config_ldap_user ?? '',
    'mot_de_passe' => $config_ldap_pass ?? '',
    'domaine' => $config_searchdn ?? '',
    'prenom' => $config_ldap_prenom ?? '',
    'nom' => $config_ldap_nom ?? '',
    'mail' => $config_ldap_mail ?? '',
    'login' => $config_ldap_login ?? '',
    'nom_affiche' => $config_ldap_nomaff ?? '',
    'filtre' => $config_ldap_filtre ?? '',
    'filtre_recherche' => $config_ldap_filrech ?? '',
];
if (!setDataConfigurationApi($dbConfiguration, $ldapConfiguration)) {
    displayFail();
}

$updateLang = "UPDATE conges_config SET conf_valeur = 'fr_FR' WHERE conf_nom = 'lang' LIMIT 1";
$db->query($updateLang);

echo 'Installation terminée avec succès.', "\n";
